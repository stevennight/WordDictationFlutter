# 自动同步功能说明

## 概述

自动同步功能已从原来的"定期自动同步"升级为更智能的同步机制，现在支持以下三种触发方式：

1. **应用启动时同步** - 每次启动应用时自动执行同步
2. **应用关闭时同步** - 应用进入后台或关闭时自动执行同步
3. **定时间隔同步** - 根据配置的时间间隔定期执行同步

## 功能特点

### 智能触发机制
- **启动同步**：确保应用启动时获取最新的云端数据
- **关闭同步**：确保本地数据在应用关闭前上传到云端
- **定时同步**：在应用运行期间定期保持数据同步

### 同步内容
- **历史记录数据**：包括默写会话、结果和session文件（图片）
- **智能合并**：自动处理本地和云端数据的冲突
- **增量同步**：只同步有变化的数据，提高效率

### 配置选项
- **同步间隔**：支持30分钟、1小时、6小时、12小时、1天等选项
- **启用/禁用**：可以随时开启或关闭自动同步
- **多配置支持**：支持多个同步配置，每个配置独立管理

## 使用方法

### 1. 启用自动同步

1. 打开应用设置
2. 进入"同步设置"
3. 添加或编辑同步配置
4. 开启"自动同步"开关
5. 选择合适的同步间隔

### 2. 同步配置说明

在同步配置对话框中：
- **自动同步开关**：控制是否启用自动同步
- **同步间隔**：设置定时同步的时间间隔
- **描述文本**："在应用启动、关闭和定时间隔时自动同步历史记录数据"

### 3. 状态显示

在同步状态卡片中会显示：
- **手动同步**：未启用自动同步时显示
- **自动同步: 启动/关闭/每X小时**：启用自动同步时显示触发方式和间隔

## 技术实现

### 核心组件

1. **AutoSyncManager**：自动同步管理器
   - 管理应用生命周期监听
   - 控制定时同步任务
   - 协调各种同步触发机制

2. **WidgetsBindingObserver**：应用状态监听
   - 监听应用前台/后台切换
   - 处理应用关闭事件

3. **Timer**：定时任务管理
   - 根据最小同步间隔创建定时器
   - 动态调整定时器配置

### 同步流程

1. **初始化阶段**
   ```
   应用启动 → 初始化AutoSyncManager → 注册生命周期监听 → 执行启动同步 → 启动定时同步
   ```

2. **运行阶段**
   ```
   定时器触发 → 检查同步条件 → 执行智能同步 → 更新同步时间
   ```

3. **关闭阶段**
   ```
   应用进入后台 → 触发关闭同步 → 上传本地数据 → 清理资源
   ```

## 注意事项

1. **网络依赖**：自动同步需要网络连接，无网络时会跳过同步
2. **电量消耗**：频繁同步可能增加电量消耗，建议合理设置同步间隔
3. **存储空间**：同步会下载云端数据，请确保有足够的存储空间
4. **冲突处理**：当本地和云端数据冲突时，系统会智能合并或提示用户选择

## 故障排除

### 常见问题

1. **同步不工作**
   - 检查网络连接
   - 确认同步配置正确
   - 查看是否启用了自动同步

2. **同步频率异常**
   - 检查同步间隔设置
   - 确认没有多个配置冲突
   - 重启应用重新初始化

3. **数据丢失**
   - 检查云端存储配置
   - 确认同步权限正常
   - 查看同步日志信息

### 调试信息

应用会在控制台输出详细的同步日志，包括：
- `[AutoSyncManager] 初始化自动同步管理器`
- `[AutoSyncManager] 开始执行自动同步 - 启动/关闭/定时同步`
- `[AutoSyncManager] 配置 XXX 同步成功/失败`

## 更新历史

- **v1.0**：实现基于时间间隔、应用启动和关闭的自动同步功能
- 替换原有的"定期自动同步"机制
- 增强用户体验和数据安全性